name: Build and Release (All Platforms)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up APT sources (OBS PPA)
        run: |
          sudo add-apt-repository -y ppa:obsproject/obs-studio || true
          sudo apt-get update

      - name: Install build dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build \
            qt6-base-dev qt6-base-private-dev libqt6svg6-dev qt6-wayland-dev \
            obs-studio libobs-dev || true

      - name: Configure (Release)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo

      - name: Build
        run: cmake --build build -j 4

      - name: Package (Linux, system-level layout)
        run: |
          bash scripts/package-linux.sh build dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: dist/*.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies (Homebrew)
        run: |
          brew update
          brew install cmake ninja qt obs || true
          echo "CMAKE_PREFIX_PATH=$(brew --prefix qt)/lib/cmake:${CMAKE_PREFIX_PATH}" >> $GITHUB_ENV

      - name: Configure (Release)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo

      - name: Build
        run: cmake --build build -j 4

      - name: Package (macOS, system-level layout)
        run: |
          bash scripts/package-macos.sh build dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: dist/*.zip

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt (6.x)
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.8.3
          host: windows
          target: desktop
          arch: win64_msvc2019_64

      - name: Install tools
        run: |
          choco install ninja -y

      - name: Configure (Release)
        shell: bash
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo

      - name: Build
        shell: bash
        run: cmake --build build -j 4

      - name: Package (Windows, system-level layout)
        shell: pwsh
        run: |
          pwsh -File scripts/package-windows.ps1 -BuildDir build -OutDir dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: dist/*.zip

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Gather assets
        run: |
          mkdir -p release
          find artifacts -name "*.zip" -exec cp {} release/ \;

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

